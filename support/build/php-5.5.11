#!/usr/bin/env bash
# Build Path: /app/.heroku/php/
# Build Deps: libraries/zlib, libraries/libmemcached, libraries/libmcrypt, libraries/icu

OUT_PREFIX=$1

# fail hard
set -o pipefail
# fail harder
set -eux

export PATH=$OUT_PREFIX/bin:$PATH


# Take care of vendoring
dep_version=${VERSION:-5.5.11}
dep_dirname=php-$dep_version
dep_archive_name=$dep_dirname.tar.bz2


echo "=== Building PHP"

# Download PHP source.
echo "Fetching PHP v$dep_version source..."
curl -Lo $dep_archive_name http://us1.php.net/get/$dep_archive_name/from/www.php.net/mirror

# Clean and extract PHP.
rm -rf $dep_dirname
tar jxf $dep_archive_name


# Compile PHP
echo "Compiling PHP v$dep_version..."

# cannot be built shared: date, ereg, opcache (always), pcre, reflection, sockets (?), spl, standard,
pushd $dep_dirname
LD_LIBRARY_PATH=$OUT_PREFIX ./configure \
    --prefix=$OUT_PREFIX \
    --with-config-file-path=/app/.heroku/php/etc/php \
    --with-config-file-scan-dir=/app/.heroku/php/etc/php/conf.d \
    --enable-fpm \
    --with-bz2 \
    --with-curl \
    --with-mcrypt=$OUT_PREFIX \
    --with-openssl \
    --with-readline \
    --enable-sockets \
    --enable-zip \
    --with-zlib \
    --with-zlib-dir=$OUT_PREFIX \
    --enable-bcmath \
    --enable-exif=shared \
    --with-gd=shared \
        --enable-gd-native-ttf \
        --with-freetype-dir=/usr \
        --with-jpeg-dir=/usr \
        --with-png-dir=/usr \
    --enable-intl=shared \
    --enable-mbstring=shared \
    --with-pdo-mysql=shared \
    --with-mysqli=shared \
    --enable-pcntl=shared \
    --with-pgsql=shared \
    --with-pdo-pgsql=shared \
    --enable-shmop=shared \
    --enable-soap=shared \
    --with-xmlrpc=shared \
    --with-xsl=shared
make -s
make install -s
popd

echo "=== Building Built-In PHP Extensions"


echo "Fetching PHP Memcache Extension..."
curl -L https://github.com/php-memcached-dev/php-memcached/archive/2.2.0.tar.gz | tar xz
pushd php-memcached-2.2.0
phpize

echo "Building PHP Memcache Extension..."
./configure \
    --enable-memcached \
    --with-libmemcached-dir=$OUT_PREFIX
make -s
make install -s
popd

echo "=== Preparing Packaging Tools"

echo "Updating PECL Channel: pecl.php.net..."
$OUT_PREFIX/bin/pecl channel-update pecl.php.net

echo "Bundling Latest Composer..."
curl -sS https://getcomposer.org/installer | php -- --install-dir=$OUT_PREFIX/bin
mv $OUT_PREFIX/bin/composer.phar $OUT_PREFIX/bin/composer

echo "Done building PHP v$dep_version!"
