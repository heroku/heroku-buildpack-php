name: CI

on:
  push:
    branches:
      - "main"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  src_path_suffix: "-develop/"
  HEROKU_DISABLE_AUTOUPDATE: 1
  HATCHET_RETRIES: 3
  IS_RUNNING_ON_CI: true
  HATCHET_APP_LIMIT: 300
  HATCHET_EXPENSIVE_MODE: 1
  HATCHET_BUILDPACK_BASE: https://github.com/heroku/heroku-buildpack-php
  HATCHET_BUILDPACK_BRANCH: ${{ github.head_ref || github.ref_name }}
  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
  HEROKU_API_USER: ${{ secrets.HEROKU_API_USER }}
  GIT_HTTP_LOW_SPEED_LIMIT: 1000
  GIT_HTTP_LOW_SPEED_TIME: 300

jobs:
  integration-test:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        stack: ["heroku-24"]
    env:
      STACK: ${{ matrix.stack }}
      BLACKFIRE_CLIENT_ID:  ${{ secrets.BLACKFIRE_CLIENT_ID }}
      BLACKFIRE_CLIENT_TOKEN: ${{ secrets.BLACKFIRE_CLIENT_TOKEN }}
      BLACKFIRE_SERVER_ID: ${{ secrets.BLACKFIRE_SERVER_ID }}
      BLACKFIRE_SERVER_TOKEN: ${{ secrets.BLACKFIRE_SERVER_TOKEN }}
    steps:
      - name: Install musl-tools
        run: sudo apt-get install -y --no-install-recommends musl-tools
